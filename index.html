<!DOCTYPE html>
<html>
    <head>
        <script src="./socket.io/socket.io.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.ckeditor.com/4.19.1/standard/ckeditor.js"></script>
    </head>
    <body>
        <header>
            <ul>
                <li><a href="/resetPassword.html">修改密码</a></li>
            </ul>
        </header>
        <form id="textform">
            <input type="text" id="textinput">
            <button>发送</button>
        </form>
        <form id="htmlform" hidden=true>
            <textarea name="htmleditor" id="htmleditor"></textarea>
            <button>发送</button>
        </form>
        <button id="changeModeButton">切换编辑模式</button>
        <ul id="message">

        </ul>
        <script>
            console.log("本项目开源地址:https://github.com/SXCxavier/SdsxcWechat");

            const socket=io();
            const textform=document.querySelector("#textform");
            const htmlform=document.querySelector("#htmlform");
            const textinput=document.querySelector("#textinput");
            const changeModeButton=document.querySelector("#changeModeButton");
            const ul=document.querySelector("#message");

            //初始化富文本编辑器
            window.onload = function () {
                CKEDITOR.replace('htmleditor', {height: "50%",width:"100%"});
            };


            //login
            var nickname="";
            var login=function(username,password){
                axios.get("/login?username="+username+"&password="+password).then(function(result){
                    if(result.data=="password error"){
                        alert("密码错误");
                        history["go"](-1);
                    }
                    else if(result.data=="no user"){
                        alert("找不到用户"+username);
                        history["go"](-1);
                    }
                    else{
                        nickname=result.data.nickname;
                    }
                });
            }
			
			login(prompt("用户名"),prompt("密码"));
			
            //切换消息模式
            var changeMessageMode=function(){
                textform.hidden=!textform.hidden;
                htmlform.hidden=!htmlform.hidden;
            }
            changeModeButton.addEventListener("click",changeMessageMode);

            //核心功能
            textform.addEventListener("submit",function(e){
                e.preventDefault();
                if(textinput.value){
					if(textinput.value.length>500){
						alert("内容过长，请上传到 https://wormhole.app/ 然后发送超链接或使用富文本模式");
					}
                    socket.emit("text message",nickname+":"+textinput.value);
                    textinput.value='';
                }
            });
            htmlform.addEventListener("submit",function(e){
                e.preventDefault();
                if(CKEDITOR.instances.htmleditor.getData()){
					if(CKEDITOR.instances.htmleditor.getData().length>51200){
						alert("内容过长，请上传到 https://wormhole.app/ 然后发送超链接");
					}
                    socket.emit("html message",nickname+":"+CKEDITOR.instances.htmleditor.getData());
                    CKEDITOR.instances.htmleditor.setData("");
                }
            });
            socket.on("text message",function(msg){
                console.log("textMessage:",msg);
                var li=document.createElement("li");
                li.textContent=msg;
                ul.appendChild(li);
            });
            socket.on("html message",function(msg){
                console.log("htmlMessage:",msg);
                var li=document.createElement("li");
                li.innerHTML=msg;
                ul.appendChild(li);
            });
        </script>
    </body>
</html>